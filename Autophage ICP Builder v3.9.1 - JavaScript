/**
 * Autophage ICP Builder v3.9.1 - JavaScript
 * Handles all interactivity, form handling, and Apollo URL generation
 */

(function() {
  'use strict';

  // State object to hold all form data
  const state = {
    offer: '',
    yourIndustry: '',
    targetIndustry: '',
    industries: [],
    keywords: [],
    companyKeywords: [],
    companyType: '',
    empRange: '11-50',
    revRange: '1m-5m',
    businessModel: '',
    marketType: 'B2B',
    salesCycle: 'Short (< 30 days)',
    dealSize: 5000,
    departments: [],
    techSignals: [],
    fundingStage: '',
    geoScope: 'local',
    zip: '',
    state: '',
    radius: 25,
    country: 'United States',
    regions: [],
    countries: '',
    seniorities: [],
    jobTitles: [],
    verifiedEmails: false
  };

  // Industry presets with suggested data
  const industryPresets = {
    technology: {
      keywords: ['SaaS', 'Cloud', 'API', 'DevOps'],
      techSignals: ['Salesforce', 'HubSpot', 'AWS'],
      departments: ['Engineering', 'Product']
    },
    roofing: {
      keywords: ['Commercial Roofing', 'Residential', 'TPO', 'Shingle'],
      departments: ['Operations', 'Sales']
    },
    solar: {
      keywords: ['Solar Panel', 'Renewable Energy', 'Installation'],
      departments: ['Sales', 'Operations']
    },
    hvac: {
      keywords: ['HVAC', 'Air Conditioning', 'Heating'],
      departments: ['Service', 'Sales']
    }
    // Add more presets as needed
  };

  // Available options for multi-select
  const departments = ['Sales', 'Marketing', 'Engineering', 'Product', 'Operations', 'Finance', 'HR', 'Customer Success'];
  const seniorities = ['Entry', 'Manager', 'Director', 'VP', 'C-Suite', 'Owner'];
  const techSignals = ['Salesforce', 'HubSpot', 'Marketo', 'Pardot', 'AWS', 'Google Cloud', 'Azure', 'Shopify', 'WordPress', 'React', 'Angular', 'Vue'];
  const regions = ['North America', 'Europe', 'Asia Pacific', 'Latin America', 'Middle East', 'Africa'];

  // Initialize on DOM load
  document.addEventListener('DOMContentLoaded', init);

  function init() {
    console.log('ICP Builder initializing...');
    
    // Setup all event listeners
    setupBasicInputs();
    setupChipInputs();
    setupTabs();
    setupSteps();
    setupMultiSelects();
    setupGeography();
    setupSlider();
    setupButtons();
    setupDebugPanel();
    
    // Initial confidence calculation
    updateConfidence();
    
    console.log('ICP Builder initialized successfully');
  }

  // Setup basic input listeners
  function setupBasicInputs() {
    // Text inputs
    const textInputs = ['offer', 'yourIndustry'];
    textInputs.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('change', (e) => {
        state[id] = e.target.value;
        updateConfidence();
      });
    });

    // Dropdowns
    const dropdowns = ['industry', 'companyType', 'empRange', 'revRange', 'businessModel', 'salesCycle', 'fundingStage'];
    dropdowns.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('change', (e) => {
        state[id === 'industry' ? 'targetIndustry' : id] = e.target.value;
        if (id === 'industry') loadIndustryPreset(e.target.value);
        updateConfidence();
      });
    });

    // Checkbox
    const verifiedEl = document.getElementById('verifiedEmails');
    if (verifiedEl) {
      verifiedEl.addEventListener('change', (e) => {
        state.verifiedEmails = e.target.checked;
        updateConfidence();
      });
    }
  }

  // Setup chip inputs (keywords, industries, titles, etc.)
  function setupChipInputs() {
    setupChipInput('industryInput', 'industriesChips', 'industries');
    setupChipInput('keywordInput', 'keywordsChips', 'keywords');
    setupChipInput('companyKeywordInput', 'companyKeywordsChips', 'companyKeywords');
    setupChipInput('titleInput', 'titlesChips', 'jobTitles');
  }

  function setupChipInput(inputId, chipsId, stateKey) {
    const input = document.getElementById(inputId);
    const chipsContainer = document.getElementById(chipsId);
    
    if (!input || !chipsContainer) return;

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && input.value.trim()) {
        e.preventDefault();
        const value = input.value.trim();
        
        if (!state[stateKey].includes(value)) {
          state[stateKey].push(value);
          renderChips(chipsContainer, state[stateKey], stateKey);
          updateConfidence();
        }
        
        input.value = '';
      }
    });
  }

  function renderChips(container, items, stateKey) {
    container.innerHTML = items.map((item, index) => `
      <div class="chip">
        ${item}
        <span class="remove" data-index="${index}" data-key="${stateKey}">Ã—</span>
      </div>
    `).join('');

    // Add remove listeners
    container.querySelectorAll('.remove').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const index = parseInt(e.target.dataset.index);
        const key = e.target.dataset.key;
        state[key].splice(index, 1);
        renderChips(container, state[key], key);
        updateConfidence();
      });
    });
  }

  // Setup tabs (Market Type, Geo Scope)
  function setupTabs() {
    // Market type tabs
    const marketTabs = document.getElementById('marketTabs');
    if (marketTabs) {
      marketTabs.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          marketTabs.querySelectorAll('.tab').forEach(t => {
            t.classList.remove('active');
            t.setAttribute('aria-selected', 'false');
          });
          tab.classList.add('active');
          tab.setAttribute('aria-selected', 'true');
          state.marketType = tab.dataset.market;
          updateConfidence();
        });
      });
    }

    // Geo scope tabs
    const scopeTabs = document.getElementById('scopeTabs');
    if (scopeTabs) {
      scopeTabs.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const scope = tab.dataset.scope;
          
          scopeTabs.querySelectorAll('.tab').forEach(t => {
            t.classList.remove('active');
            t.setAttribute('aria-selected', 'false');
          });
          tab.classList.add('active');
          tab.setAttribute('aria-selected', 'true');
          
          state.geoScope = scope;
          
          // Show/hide relevant sections
          document.getElementById('scopeLocal').style.display = scope === 'local' ? 'block' : 'none';
          document.getElementById('scopeNational').style.display = scope === 'national' ? 'block' : 'none';
          document.getElementById('scopeInternational').style.display = scope === 'international' ? 'block' : 'none';
          
          updateConfidence();
        });
      });
    }
  }

  // Setup deal size steps
  function setupSteps() {
    const steps = document.getElementById('dealSteps');
    if (!steps) return;

    steps.querySelectorAll('.step').forEach(step => {
      step.addEventListener('click', () => {
        steps.querySelectorAll('.step').forEach(s => {
          s.classList.remove('active');
          s.setAttribute('aria-checked', 'false');
        });
        step.classList.add('active');
        step.setAttribute('aria-checked', 'true');
        
        state.dealSize = parseInt(step.dataset.val);
        document.getElementById('dealSize').value = state.dealSize;
        updateConfidence();
      });
    });
  }

  // Setup multi-select tiles
  function setupMultiSelects() {
    setupMultiSelect('departments', departments, 'departments');
    setupMultiSelect('seniorities', seniorities, 'seniorities');
    setupMultiSelect('techTiles', techSignals, 'techSignals', true);
    setupMultiSelect('regions', regions, 'regions');
  }

  function setupMultiSelect(containerId, options, stateKey, isGrid = false) {
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = options.map(option => `
      <div class="${isGrid ? 'tile' : 'pill'}" data-value="${option}">
        ${option}
      </div>
    `).join('');

    container.querySelectorAll(isGrid ? '.tile' : '.pill').forEach(item => {
      item.addEventListener('click', () => {
        const value = item.dataset.value;
        
        if (state[stateKey].includes(value)) {
          state[stateKey] = state[stateKey].filter(v => v !== value);
          item.classList.remove('selected');
        } else {
          state[stateKey].push(value);
          item.classList.add('selected');
        }
        
        updateConfidence();
      });
    });
  }

  // Setup geography inputs
  function setupGeography() {
    const zipInput = document.getElementById('zip');
    const stateInput = document.getElementById('state');
    const countryInput = document.getElementById('country');
    const countriesInput = document.getElementById('countries');

    if (zipInput) zipInput.addEventListener('input', (e) => {
      state.zip = e.target.value;
      updateConfidence();
    });

    if (stateInput) stateInput.addEventListener('change', (e) => {
      state.state = e.target.value;
      updateConfidence();
    });

    if (countryInput) countryInput.addEventListener('change', (e) => {
      state.country = e.target.value;
      updateConfidence();
    });

    if (countriesInput) countriesInput.addEventListener('input', (e) => {
      state.countries = e.target.value;
      updateConfidence();
    });
  }

  // Setup radius slider
  function setupSlider() {
    const slider = document.getElementById('radius');
    const valueDisplay = document.getElementById('radiusVal');
    
    if (slider && valueDisplay) {
      slider.addEventListener('input', (e) => {
        const value = e.target.value;
        state.radius = parseInt(value);
        valueDisplay.textContent = value;
        updateConfidence();
      });
    }
  }

  // Setup buttons
  function setupButtons() {
    const btnGenerate = document.getElementById('btnGenerate');
    const btnReset = document.getElementById('btnReset');
    const btnCopyApollo = document.getElementById('btnCopyApollo');
    const btnOpenRelaxed = document.getElementById('btnOpenRelaxed');
    const btnExportTxt = document.getElementById('btnExportTxt');
    const btnExportPDF = document.getElementById('btnExportPDF');
    const btnExportJSON = document.getElementById('btnExportJSON');

    if (btnGenerate) btnGenerate.addEventListener('click', generateICP);
    if (btnReset) btnReset.addEventListener('click', resetForm);
    if (btnCopyApollo) btnCopyApollo.addEventListener('click', copyApolloLink);
    if (btnOpenRelaxed) btnOpenRelaxed.addEventListener('click', openRelaxedLink);
    if (btnExportTxt) btnExportTxt.addEventListener('click', exportTxt);
    if (btnExportPDF) btnExportPDF.addEventListener('click', exportPDF);
    if (btnExportJSON) btnExportJSON.addEventListener('click', exportJSON);
  }

  // Setup debug panel
  function setupDebugPanel() {
    const toggle = document.getElementById('debugToggle');
    const body = document.getElementById('debugBody');
    
    if (toggle && body) {
      toggle.addEventListener('click', () => {
        body.classList.toggle('open');
      });
    }
  }

  // Load industry preset
  function loadIndustryPreset(industry) {
    const preset = industryPresets[industry];
    if (!preset) return;

    // Update keywords
    if (preset.keywords) {
      state.keywords = [...new Set([...state.keywords, ...preset.keywords])];
      renderChips(document.getElementById('keywordsChips'), state.keywords, 'keywords');
    }

    // Update tech signals
    if (preset.techSignals) {
      preset.techSignals.forEach(tech => {
        if (!state.techSignals.includes(tech)) {
          state.techSignals.push(tech);
          const tile = document.querySelector(`#techTiles .tile[data-value="${tech}"]`);
          if (tile) tile.classList.add('selected');
        }
      });
    }

    // Update departments
    if (preset.departments) {
      preset.departments.forEach(dept => {
        if (!state.departments.includes(dept)) {
          state.departments.push(dept);
          const pill = document.querySelector(`#departments .pill[data-value="${dept}"]`);
          if (pill) pill.classList.add('selected');
        }
      });
    }

    updateConfidence();
  }

  // Calculate and update confidence score
  function updateConfidence() {
    let score = 0;
    let maxScore = 100;

    // Scoring logic
    if (state.targetIndustry) score += 15;
    if (state.industries.length > 0) score += 10;
    if (state.keywords.length > 0) score += 10;
    if (state.empRange) score += 10;
    if (state.departments.length > 0) score += 10;
    if (state.seniorities.length > 0) score += 15;
    if (state.jobTitles.length > 0) score += 15;
    
    // Geography scoring
    if (state.geoScope === 'local' && (state.zip || state.state)) score += 10;
    if (state.geoScope === 'national' && state.country) score += 10;
    if (state.geoScope === 'international' && (state.regions.length > 0 || state.countries)) score += 10;
    
    if (state.techSignals.length > 0) score += 5;

    // Update UI
    const percentage = Math.min(100, Math.round((score / maxScore) * 100));
    const confFill = document.getElementById('confFill');
    const confPct = document.getElementById('confPct');
    
    if (confFill) confFill.style.width = percentage + '%';
    if (confPct) confPct.textContent = percentage + '%';

    // Update hint
    const hint = document.getElementById('volumeHint');
    if (hint) {
      if (percentage < 30) {
        hint.innerHTML = '<span class="dot"></span><span class="muted">Low confidence - add more filters</span>';
      } else if (percentage < 70) {
        hint.innerHTML = '<span class="dot"></span><span class="muted">Medium confidence - add titles or seniorities</span>';
      } else {
        hint.innerHTML = '<span class="dot"></span><span class="muted">High confidence - good targeting!</span>';
      }
    }
  }

  // Generate ICP
  function generateICP() {
    console.log('Generating ICP...', state);
    
    // Scroll to results
    document.getElementById('resultsTop').scrollIntoView({ behavior: 'smooth' });

    // Generate narrative
    const narrative = generateNarrative();
    typeWriter(document.getElementById('output'), narrative);

    // Generate Apollo URL
    const apolloUrl = generateApolloUrl();
    const urlDisplay = document.getElementById('apolloUrl');
    const openBtn = document.getElementById('btnOpenApollo');
    
    if (urlDisplay) urlDisplay.textContent = apolloUrl;
    if (openBtn) openBtn.href = apolloUrl;

    // Update summary
    const summary = document.getElementById('summaryBar');
    if (summary) {
      summary.textContent = `Generated ICP targeting ${state.targetIndustry || 'multiple industries'} with ${state.empRange} employees`;
    }

    // Update debug panel
    updateDebugPanel();

    showMessage('ICP generated successfully! âœ¨', 'success');
  }

  // Generate narrative text
  function generateNarrative() {
    const parts = [];

    parts.push(`<div class="out-sec"><h3 class="out-h3">Overview</h3><div class="out-body">`);
    parts.push(`This ICP targets ${state.marketType} companies`);
    if (state.targetIndustry) parts.push(` in the ${state.targetIndustry} industry`);
    if (state.empRange) parts.push(` with ${state.empRange} employees`);
    parts.push(`.`);
    parts.push(`</div></div>`);

    if (state.offer) {
      parts.push(`<div class="out-sec"><h3 class="out-h3">Offering</h3><div class="out-body">`);
      parts.push(`Our service: <strong>${state.offer}</strong>`);
      parts.push(`</div></div>`);
    }

    if (state.departments.length > 0 || state.seniorities.length > 0) {
      parts.push(`<div class="out-sec"><h3 class="out-h3">Target Personas</h3><div class="out-body">`);
      if (state.seniorities.length > 0) {
        parts.push(`Looking for ${state.seniorities.join(', ')} level contacts`);
      }
      if (state.departments.length > 0) {
        parts.push(` in ${state.departments.join(', ')} departments`);
      }
      parts.push(`.`);
      if (state.jobTitles.length > 0) {
        parts.push(` Specific titles include: ${state.jobTitles.join(', ')}.`);
      }
      parts.push(`</div></div>`);
    }

    if (state.geoScope) {
      parts.push(`<div class="out-sec"><h3 class="out-h3">Geography</h3><div class="out-body">`);
      if (state.geoScope === 'local') {
        parts.push(`Local targeting`);
        if (state.zip) parts.push(` around ZIP code ${state.zip}`);
        if (state.state) parts.push(` in ${state.state}`);
        parts.push(` with a ~${state.radius} mile radius.`);
      } else if (state.geoScope === 'national') {
        parts.push(`National targeting in ${state.country}.`);
      } else {
        parts.push(`International targeting`);
        if (state.regions.length > 0) parts.push(` across ${state.regions.join(', ')}`);
        if (state.countries) parts.push(` focusing on ${state.countries}`);
        parts.push(`.`);
      }
      parts.push(`</div></div>`);
    }

    if (state.techSignals.length > 0) {
      parts.push(`<div class="out-sec"><h3 class="out-h3">Tech Stack</h3><div class="out-body">`);
      parts.push(`Companies using: ${state.techSignals.join(', ')}.`);
      parts.push(`</div></div>`);
    }

    parts.push(`<div class="out-sec"><h3 class="out-h3">Sales Strategy</h3><div class="out-body">`);
    parts.push(`${state.salesCycle} sales cycle with an average deal size of $${state.dealSize.toLocaleString()}.`);
    parts.push(`</div></div>`);

    return parts.join('');
  }

  // Typewriter effect
  function typeWriter(element, html, speed = 5) {
    element.innerHTML = '';
    let i = 0;
    
    function type() {
      if (i < html.length) {
        element.innerHTML += html.charAt(i);
        i++;
        setTimeout(type, speed);
      }
    }
    
    // For faster display, just set innerHTML directly
    element.innerHTML = html;
  }

  // Generate Apollo URL
  function generateApolloUrl() {
    const baseUrl = 'https://app.apollo.io/#/people';
    const params = {};

    // Add person filters
    if (state.seniorities.length > 0) {
      params.personSeniorities = state.seniorities;
    }
    if (state.jobTitles.length > 0) {
      params.personTitles = state.jobTitles;
    }
    if (state.departments.length > 0) {
      params.personDepartments = state.departments;
    }

    // Add organization filters
    if (state.targetIndustry) {
      params.organizationIndustries = [state.targetIndustry];
    }
    if (state.industries.length > 0) {
      params.organizationIndustries = [...(params.organizationIndustries || []), ...state.industries];
    }
    
    // Employee count
    const empMap = {
      '1-10': { min: 1, max: 10 },
      '11-50': { min: 11, max: 50 },
      '51-200': { min: 51, max: 200 },
      '201-500': { min: 201, max: 500 },
      '501-1000': { min: 501, max: 1000 },
      '1001-5000': { min: 1001, max: 5000 },
      '5001+': { min: 5001, max: null }
    };
    const empRange = empMap[state.empRange];
    if (empRange) {
      params.organizationNumEmployeesMin = empRange.min;
      if (empRange.max) params.organizationNumEmployeesMax = empRange.max;
    }

    // Geography
    if (state.geoScope === 'local' && state.state) {
      params.personLocations = [state.state];
    } else if (state.geoScope === 'national') {
      params.personLocations = [state.country];
    } else if (state.geoScope === 'international' && state.countries) {
      params.personLocations = state.countries.split(',').map(c => c.trim());
    }

    // Keywords
    if (state.keywords.length > 0) {
      params.q_keywords = state.keywords.join(' OR ');
    }

    // Tech stack
    if (state.techSignals.length > 0) {
      params.organizationTechnologies = state.techSignals;
    }

    // Verified emails
    if (state.verifiedEmails) {
      params.contactEmailStatus = 'verified';
    }

    // Encode and return
    return baseUrl + '?finderViewId=custom&' + Object.entries(params)
      .map(([key, val]) => {
        const value = Array.isArray(val) ? JSON.stringify(val) : val;
        return `${key}=${encodeURIComponent(value)}`;
      })
      .join('&');
  }

  // Update debug panel
  function updateDebugPanel() {
    const dbgPerson = document.getElementById('dbgPerson');
    const dbgOrg = document.getElementById('dbgOrg');
    const dbgKw = document.getElementById('dbgKw');
    const dbgMisc = document.getElementById('dbgMisc');

    if (dbgPerson) {
      dbgPerson.innerHTML = `
        <div>Seniorities: ${state.seniorities.join(', ') || 'none'}</div>
        <div>Titles: ${state.jobTitles.join(', ') || 'none'}</div>
        <div>Departments: ${state.departments.join(', ') || 'none'}</div>
      `;
    }

    if (dbgOrg) {
      dbgOrg.innerHTML = `
        <div>Industry: ${state.targetIndustry || 'none'}</div>
        <div>Additional: ${state.industries.join(', ') || 'none'}</div>
        <div>Employees: ${state.empRange}</div>
        <div>Tech: ${state.techSignals.join(', ') || 'none'}</div>
      `;
    }

    if (dbgKw) {
      dbgKw.innerHTML = `
        <div>Keywords: ${state.keywords.join(', ') || 'none'}</div>
        <div>Company KW: ${state.companyKeywords.join(', ') || 'none'}</div>
      `;
    }

    if (dbgMisc) {
      dbgMisc.innerHTML = `
        <div>Geo: ${state.geoScope}</div>
        <div>Deal Size: $${state.dealSize.toLocaleString()}</div>
        <div>Verified: ${state.verifiedEmails}</div>
      `;
    }
  }

  // Copy Apollo link
  function copyApolloLink() {
    const url = document.getElementById('apolloUrl').textContent;
    navigator.clipboard.writeText(url).then(() => {
      showMessage('Apollo link copied! ðŸ“‹', 'success');
    });
  }

  // Open relaxed link
  function openRelaxedLink() {
    const url = generateApolloUrl();
    window.open(url, '_blank');
  }

  // Export functions
  function exportTxt() {
    const narrative = document.getElementById('output').innerText;
    const blob = new Blob([narrative], { type: 'text/plain' });
    downloadBlob(blob, 'icp-profile.txt');
    showMessage('TXT exported! ðŸ“„', 'success');
  }

  function exportPDF() {
    showMessage('PDF export requires server-side processing', 'info');
  }

  function exportJSON() {
    const json = JSON.stringify(state, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    downloadBlob(blob, 'icp-profile.json');
    showMessage('JSON exported! ðŸ’¾', 'success');
  }

  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // Reset form
  function resetForm() {
    if (!confirm('Reset all fields?')) return;
    
    // Reset state
    Object.keys(state).forEach(key => {
      if (Array.isArray(state[key])) state[key] = [];
      else if (typeof state[key] === 'boolean') state[key] = false;
      else if (typeof state[key] === 'number') state[key] = key === 'dealSize' ? 5000 : key === 'radius' ? 25 : 0;
      else state[key] = '';
    });

    // Reset UI
    document.querySelectorAll('.a-icp input[type="text"], .a-icp input[type="number"]').forEach(el => el.value = '');
    document.querySelectorAll('.a-icp select').forEach(el => el.selectedIndex = 0);
    document.querySelectorAll('.a-icp .chip-row').forEach(el => el.innerHTML = '');
    document.querySelectorAll('.a-icp .tile.selected, .a-icp .pill.selected').forEach(el => el.classList.remove('selected'));
    document.getElementById('verifiedEmails').checked = false;
    document.getElementById('output').innerHTML = '<div class="placeholder">Awaiting inputâ€¦ Your ICP narrative will render here with a typing animation once generated.</div>';
    
    updateConfidence();
    showMessage('Form reset! ðŸ”„', 'info');
  }

  // Show message
  function showMessage(text, type = 'info') {
    const msg = document.getElementById('inlineMsg');
    if (msg) {
      msg.textContent = text;
      msg.style.color = type === 'success' ? 'var(--phage-green)' : type === 'error' ? '#ff4444' : 'var(--phage-cyan)';
      setTimeout(() => msg.textContent = '', 3000);
    }
  }

})();
